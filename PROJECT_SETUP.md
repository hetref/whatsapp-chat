# WaChat Project Setup Guide

This guide explains how to set up and run this project from scratch in a new environment.

---

## 1. Prerequisites

- Node.js 18 or newer
- npm (comes with Node.js)
- A Supabase account and project
- An AWS account with permissions to create an S3 bucket
- A Meta Business / WhatsApp Cloud API account

---

## 2. Clone and Install

1. Clone the repository:

```bash
git clone <your-repo-url>
cd whatsapp-chat
```

2. Install dependencies:

```bash
npm install
```

---

## 3. Environment Variables

Create a file named `.env.local` in the project root with the following values (these mirror `.env.example`):

```bash
# ============================================
# SUPABASE CONFIGURATION
# ============================================
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=your_supabase_anon_key

# Supabase Service Role Key (used by server-side webhooks)
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# ============================================
# AWS S3 CONFIGURATION
# ============================================
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_REGION=us-east-1
AWS_BUCKET_NAME=wachat-media-bucket
```

Notes:
- `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY` come from Supabase → Project Settings → API.
- `SUPABASE_SERVICE_ROLE_KEY` is the service_role key from the same page (keep this secret, never expose it client-side).
- AWS keys must have S3 access to the `AWS_BUCKET_NAME` bucket.

---

## 4. Supabase Database Setup

1. Go to your Supabase project → SQL Editor.
2. Copy the full SQL from `DATABASE_SETUP.md` in this repo.
3. Run the SQL once to create:
   - Core tables: `users`, `messages`, `chat_groups`, `group_members`, `user_settings`.
   - Indexes for performance.
   - Row Level Security (RLS) policies.
   - Helper functions (RPC):
     - `mark_messages_as_read`
     - `get_conversation_messages`
     - `get_unread_conversations`
     - `create_or_get_user`
     - `get_user_groups_with_counts`
     - `get_group_members_with_details`
   - Triggers for `updated_at` maintenance.
   - The `user_conversations` view used by the chat UI.

The `user_conversations` view is used to power the left-side user list and unread counts. It will show data only after you have `messages` stored.

---

## 5. Supabase Real-time Configuration

In Supabase dashboard:

1. Go to **Database → Replication**.
2. Ensure `supabase_realtime` publication includes these tables:
   - `users`
   - `messages`
   - `chat_groups`
   - `group_members`

The app listens to these tables using Supabase real-time channels to keep the UI in sync.

---

## 6. WhatsApp Cloud API Setup (High Level)

Per user/tenant, credentials are stored in the `user_settings` table via the UI. At a high level:

1. In Meta Developers, create a Business app and add the WhatsApp product.
2. Obtain:
   - Permanent Access Token
   - Phone Number ID
   - Business Account ID
3. In the app, after signing up and logging in:
   - Navigate to `/protected/setup`.
   - Fill the **Access Token Configuration** form with the values above and save.
4. Generate a webhook token in the setup page, then configure the webhook in Meta:
   - Webhook URL: `https://your-domain.com/api/webhook/[your-unique-token]`
   - Verify Token: the one you configured in the app.
   - Subscribe to `messages` events.

All WhatsApp credentials are stored per user in `user_settings`, not in environment variables.

---

## 7. AWS S3 Setup (Media Storage)

1. Create an S3 bucket (e.g., `wachat-media-bucket`) in your chosen region.
2. Block public access for the bucket.
3. Create an IAM user with permissions to `s3:GetObject`, `s3:PutObject`, `s3:DeleteObject` on that bucket.
4. Put that user's `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` into `.env.local`.

Media files will be stored in S3 and accessed via presigned URLs generated by the backend.

---

## 8. Running the Project

### Development

```bash
npm run dev
```

Then open:

- `http://localhost:3000` for the main app.

### Production build

```bash
npm run build
npm start
```

This uses the standard Next.js production server.

---

## 9. Summary of Core Flows

- Authentication is handled by Supabase Auth.
- Incoming WhatsApp webhooks hit `/api/webhook/[token]` and store messages into Supabase.
- Outgoing messages/media are sent via `/api/send-message` and `/api/send-media`, and also stored in Supabase.
- The chat UI under `/protected` uses Supabase real-time plus RPC functions and the `user_conversations` view to load users, unread counts, and conversation messages.
